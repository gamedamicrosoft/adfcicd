name: Deploy ADF and Databricks

on:
  push:
    branches:
      - main
      - qa

jobs:
  deploy-databricks-notebooks:
    name: Deploy Notebooks to Databricks
    runs-on: ubuntu-latest # Use your self-hosted runner

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      # Conditional loading of environments based on branch
      - name: Set environment
        id: set-env
        run: |
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "env_name=dev" >> $GITHUB_ENV
          elif [[ "${{ github.ref_name }}" == "qa" ]]; then
            echo "env_name=qa" >> $GITHUB_ENV
          fi

      - name: Install Databricks CLI
        run: pip install databricks-cli

      - name: Deploy Notebooks to Databricks
        env:
          LOCAL_NOTEBOOKS_DIR: ${{ github.workspace }}/databricks/notebooks
          DATABRICKS_HOST: https://${{ vars.DATABRICKS_URL }}
          DATABRICKS_WORKSPACE_DIR: ${{ vars.DATABRICKS_WORKSPACE_DIR }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}

        run: |
          echo "DATABRICKS_HOST= ${DATABRICKS_HOST}"
          databricks workspace import-dir "$LOCAL_NOTEBOOKS_DIR" "$DATABRICKS_WORKSPACE_DIR" --overwrite

